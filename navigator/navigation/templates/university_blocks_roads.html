{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>University Roads and Buildings</title>

  <!-- Leaflet CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotate@0.2.7/dist/leaflet-rotate.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      color: #333;
    }

    h2 {
      text-align: center;
      margin: 20px 0;
      color: #444;
    }

    #map {
      height: 600px;
      width: 100%;
    }

    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      font-size: 14px;
      line-height: 18px;
      color: #555;
    }

    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }

    .legend img {
      width: 18px;
      height: 18px;
      vertical-align: middle;
      margin-right: 8px;
    }

    .leaflet-interactive.shortest-path-glow {
      stroke: #FFD180;
      stroke-width: 10;
      filter: drop-shadow(0 0 12px #FFD180cc);
      opacity: 0.85;
      animation: pathGlow 2s infinite alternate;
    }

    @keyframes pathGlow {
      0% { filter: drop-shadow(0 0 12px #FFD180cc); opacity: 0.85; }
      100% { filter: drop-shadow(0 0 24px #FFE082ff); opacity: 1; }
    }

    .controls {
      text-align: center;
      margin: 10px;
    }

    .controls button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #FF6F00;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .controls button:hover {
      background-color: #e65c00;
    }
  </style>
</head>
<body>
  <h2>University Roads and Buildings</h2>

  <form method="POST">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Find Shortest Path</button>
  </form>

  <div class="controls">
    <button onclick="startNavigation()">Start Navigation</button>
  </div>

  <div id="map"></div>

  <script>
    let roads = [], buildings = [], shortestPath = null, map, navStarted = false;

    try {
      roads = JSON.parse('{{ road_data_json|escapejs }}');
      buildings = JSON.parse('{{ building_data_json|escapejs }}');
      shortestPath = {{ shortest_path_json|default:"null"|safe }};
    } catch (error) {
      console.error("Error parsing data:", error);
    }

    const initialPosition = shortestPath && shortestPath.coordinates.length > 0
      ? shortestPath.coordinates[0]
      : [-6.814328, 39.281655];

    map = L.map('map', {
      zoom: 18,
      rotate: true,
      touchRotate: true,
      bearing: 0
    }).setView([initialPosition[1], initialPosition[0]], 18);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '© OpenStreetMap contributors © CARTO',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    function renderRoads(data) {
      data.forEach((road, i) => {
        try {
          let geojson = typeof road.geometry === "string" ? JSON.parse(road.geometry) : road.geometry;
          L.geoJSON(geojson, {
            style: { color: "#bdbdbd", weight: 6, opacity: 0.8 }
          }).addTo(map).bindPopup(`<b>Road:</b> ${road.name || "Unnamed Road"}`);
        } catch (e) {
          console.error(`Road ${i + 1} error:`, e);
        }
      });
    }

    function renderBuildings(data) {
      data.forEach((building, i) => {
        try {
          let geojson = typeof building.geometry === "string" ? JSON.parse(building.geometry) : building.geometry;
          L.geoJSON(geojson, {
            style: {
              color: "#8d99ae", weight: 1, fillColor: "#edf2f4", fillOpacity: 0.8
            }
          }).addTo(map).bindPopup(`<b>Building:</b> ${building.name || "Unnamed Building"}`);
        } catch (e) {
          console.error(`Building ${i + 1} error:`, e);
        }
      });
    }

    function calculateBearing(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const toDeg = rad => rad * 180 / Math.PI;

      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const Δλ = toRad(lon2 - lon1);
      const y = Math.sin(Δλ) * Math.cos(φ2);
      const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    function renderShortestPath(path) {
      if (!path) return;

      const pathLayer = L.geoJSON(path, {
        style: {
          color: "#FFD180",
          weight: 10,
          opacity: 0.95,
          className: "shortest-path-glow"
        }
      }).addTo(map).bindPopup("<b>Shortest Path</b>");

      const startIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        iconSize: [38, 48],
        iconAnchor: [19, 48]
      });

      const finishIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/190/190411.png',
        iconSize: [38, 48],
        iconAnchor: [19, 48]
      });

      const coords = path.coordinates;
      const start = coords[0];
      const end = coords[coords.length - 1];

      map.fitBounds(pathLayer.getBounds(), { padding: [40, 40], maxZoom: 18, minZoom: 16 });

      const rotation = calculateBearing(start[1], start[0], end[1], end[0]);
      map.setBearing(rotation);

      setTimeout(() => {
        const startLatLng = L.latLng(start[1], start[0]);
        const offset = map.latLngToContainerPoint(startLatLng);
        map.panBy([window.innerWidth / 2 - offset.x, window.innerHeight * 0.8 - offset.y], { animate: true });
      }, 500);

      setTimeout(() => {
        L.marker([start[1], start[0]], { icon: startIcon }).addTo(map).bindPopup("Starting Point").openPopup();
        L.marker([end[1], end[0]], { icon: finishIcon }).addTo(map).bindPopup("Finishing Point");
      }, 800);
    }

    function simulateNavigation(coords) {
      if (!coords || coords.length < 2) return;
      const carIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });

      let index = 0;
      const carMarker = L.marker([coords[0][1], coords[0][0]], { icon: carIcon }).addTo(map);

      function move() {
        if (index < coords.length - 1) {
          const current = coords[index];
          const next = coords[index + 1];
          const latLng = [next[1], next[0]];
          const bearing = calculateBearing(current[1], current[0], next[1], next[0]);

          carMarker.setLatLng(latLng);
          map.setBearing(bearing);
          map.setView(latLng, map.getZoom(), { animate: true });

          index++;
          setTimeout(move, 1200);
        }
      }

      move();
    }

    function startNavigation() {
      if (navStarted) return;
      if (shortestPath && shortestPath.coordinates.length > 1) {
        navStarted = true;
        simulateNavigation(shortestPath.coordinates);
      } else {
        alert("No path found to simulate navigation.");
      }
    }

    function addLegend() {
      const legend = L.control({ position: "bottomright" });
      legend.onAdd = () => {
        const div = L.DomUtil.create("div", "legend");
        div.innerHTML = `
          <i style="background: #bdbdbd"></i> Roads<br>
          <i style="background: #edf2f4; border: 1px solid #8d99ae;"></i> Buildings<br>
          <i style="background: #FF6F00"></i> Shortest Path<br>
          <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png"> Starting Point<br>
          <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png"> Finishing Point
        `;
        return div;
      };
      legend.addTo(map);
    }

    map.on('load', function () {
      if (roads.length > 0) renderRoads(roads);
      if (buildings.length > 0) renderBuildings(buildings);
      if (shortestPath) renderShortestPath(shortestPath);
      addLegend();
    });

    map.fire('load');
  </script>
</body>
</html>
