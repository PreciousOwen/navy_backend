{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Roads and Buildings</title>

    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" />
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        h2 {
            text-align: center;
            margin: 20px 0;
            color: #444;
        }
        #map {
            height: 600px; /* Adjusted height for better view */
            width: 100%;
        }
        form {
            text-align: center;
            margin-bottom: 10px;
        }
        button {
            padding: 8px 16px;
            margin-top: 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>University Roads and Buildings</h2>

    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Find Shortest Path</button>
    </form>

    <div id="map"></div>

    <script>
        console.log("JavaScript is running!");

        // Parse road and building data
        let roads = [];
        let buildings = [];
        try {
            roads = JSON.parse('{{ road_data_json|escapejs }}');
            buildings = JSON.parse('{{ building_data_json|escapejs }}');
            console.log("Road Data:", roads);
            console.log("Building Data:", buildings);
        } catch (error) {
            console.error("Error parsing data:", error);
        }

        let shortestPath = {{ shortest_path_json|default:"null"|safe }};

        // Initialize MapLibre GL JS with OSM raster tiles
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm-tiles': {
                        type: 'raster',
                        tiles: [
                            'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
                            'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
                            'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
                        ],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors'
                    }
                },
                layers: [
                    {
                        id: 'osm-tiles',
                        type: 'raster',
                        source: 'osm-tiles'
                    }
                ]
            },
            center: [39.281655, -6.814328],
            zoom: 15,
            pitch: 50, // This gives the "incline" effect
            bearing: 30, // This gives the rotation
            maxZoom: 18 // Set your desired maximum zoom level here (e.g., 18-20 is common for detailed city views)
        });

        map.addControl(new maplibregl.NavigationControl());

        // Function to add roads to the map
        function renderRoads(roads) {
            roads.forEach(function(road, index) {
                try {
                    console.log(`Processing road ${index + 1}:`, road);
                    let geojson = road.geometry;

                    if (typeof geojson === "string") {
                        geojson = JSON.parse(geojson);
                    }

                    map.addSource(`road-${index}`, {
                        type: 'geojson',
                        data: geojson
                    });

                    map.addLayer({
                        id: `road-layer-${index}`,
                        type: 'line',
                        source: `road-${index}`,
                        paint: {
                            'line-color': '#dddddd', /* Matching the grey color from Leaflet example */
                            'line-width': 5,          /* Matching the width from Leaflet example */
                            'line-opacity': 0.9      /* Matching the opacity from Leaflet example */
                        }
                    });
                } catch (error) {
                    console.error(`Error rendering road ${index + 1}:`, error);
                }
            });
        }

        // Function to add buildings to the map
        function renderBuildings(buildings) {
            buildings.forEach(function(building, index) {
                try {
                    console.log(`Processing building ${index + 1}:`, building);
                    let geojson = building.geometry;

                    if (typeof geojson === "string") {
                        geojson = JSON.parse(geojson);
                    }

                    map.addSource(`building-${index}`, {
                        type: 'geojson',
                        data: geojson
                    });

                    map.addLayer({
                        id: `building-layer-${index}`,
                        type: 'fill',
                        source: `building-${index}`,
                        paint: {
                            'fill-color': '#f5f5f5', /* Matching the fill color from Leaflet example */
                            'fill-outline-color': '#b0b0b0', /* Matching the border color from Leaflet example */
                            'fill-opacity': 0.7       /* Matching the opacity from Leaflet example */
                        }
                    });
                } catch (error) {
                    console.error(`Error rendering building ${index + 1}:`, error);
                }
            });
        }

        // Function to render the shortest path
        function renderShortestPath() {
            if (!shortestPath) return;

            map.addSource('shortest-path', {
                type: 'geojson',
                data: shortestPath
            });

            map.addLayer({
                id: 'shortest-path-layer',
                type: 'line',
                source: 'shortest-path',
                paint: {
                    'line-color': '#4285F4', /* Matching the blue color from Leaflet example */
                    'line-width': 7,          /* Matching the width from Leaflet example */
                    'line-opacity': 0.95     /* Matching the opacity from Leaflet example */
                }
            });

            // Add start and end markers
            const startPoint = shortestPath.coordinates[0];
            const endPoint = shortestPath.coordinates.at(-1);

            // You'll need to define custom icons or use default MapLibre GL JS markers for these
            // For simplicity, let's just add regular markers here. For custom images, you'd load them first.
            new maplibregl.Marker({ color: 'green' }) // Start marker
                .setLngLat([startPoint[0], startPoint[1]])
                .setPopup(new maplibregl.Popup().setText('Starting Point'))
                .addTo(map);

            new maplibregl.Marker({ color: 'red' }) // End marker
                .setLngLat([endPoint[0], endPoint[1]])
                .setPopup(new maplibregl.Popup().setText('Finishing Point'))
                .addTo(map);

            // Fit map to path bounds
            const bounds = new maplibregl.LngLatBounds();
            shortestPath.coordinates.forEach(coord => {
                bounds.extend(coord);
            });
            map.fitBounds(bounds, { padding: 50, maxZoom: 18 });
        }


        // Wait for the style to finish loading
        map.on('load', function () {
            console.log("Map style is loaded. Rendering roads and buildings...");

            if (roads.length > 0) {
                renderRoads(roads);
            } else {
                console.warn("No roads available to render.");
            }

            if (buildings.length > 0) {
                renderBuildings(buildings);
            } else {
                console.warn("No buildings available to render.");
            }

            renderShortestPath(); // Call this after roads and buildings

            // MapLibre GL JS doesn't have a direct equivalent for Leaflet's `simulateUserPosition`
            // and dynamic bearing setting on a marker.
            // Implementing a precise simulation with bearing and smooth movement would require
            // more advanced animation techniques within MapLibre GL JS.
            // For this response, I'll focus on the initial setup and path rendering.
        });
    </script>
</body>
</html>